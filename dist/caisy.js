"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const l=(e,t)=>{let s=t?parseInt(t):1;(!s||isNaN(s))&&(s=1);const r=e.pageInfo?.hasNextPage??!1,n=e.pageInfo?.hasPreviousPage??!1,o=e.edges.map(a=>a.node);return{meta:{pagination:{total:o.length,hasNextPage:r,hasPrevPage:n,page:s}},data:c(o)}},p=e=>{if(!e.data||!Object.keys(e.data).length)return{meta:{pagination:{}},data:[]};let t=e.data[Object.keys(e.data)[0]];return t?.edges&&(t=t.edges.map(s=>s.node)?.[0]),{meta:{pagination:{}},data:[c(t)]}},c=e=>Array.isArray(e)&&!e.length?[]:e==null?null:typeof e=="object"&&!Object.keys(e).length?{}:Array.isArray(e)?e.map(t=>c(t)):Object.keys(e._meta||{})?.length?{...c(m(e))}:typeof e=="object"&&e.json&&e.json.type==="doc"?A(e):Object.keys(e).reduce((t,s)=>{const r=e[s];return r==null?(t[s]=null,t):Array.isArray(r)?(t[s]=r.map(n=>c(n)),t):typeof r=="object"?(t[s]={...c(m(r))},t):(t[s]=r,t)},{}),m=e=>{let t=e;return t?._meta&&(t={...t,...t._meta},delete t._meta),t?.__typename==="Asset"?(t={...t,...h(t)},t):(t?.__typename&&t.__typename!=="Asset"&&(t={typeId:t?.__typename,...t}),"latitude"in t&&"longitude"in t&&(t={lat:t.latitude,lon:t.longitude,address:t.formattedAddress,zoom:t.zoom}),t)},h=e=>({id:e.id,name:e.title,alt:e.keywords,url:e.src,assetType:e.originType,size:{height:e.height,width:e.width}}),A=e=>e.connections?!e.json||typeof e.json=="string"?"":{content:e.json.content.map(s=>{if(s.type!=="documentLink"||!e.connections)return s;const r=e.connections.find(n=>n?.__typename=="Asset"&&n.id===s.attrs.documentId);return r&&(s.attrs={...s.attrs,src:r.src,title:r.title}),s}),type:e.json.type}:e.json,g=e=>`https://cloud.caisy.io/api/v3/e/${e}/graphql`,f=async e=>{if(e.status===401||e.status===403)throw new Error(`Caisy auth or permission issue: ${e.statusText}`);if(e.status!==200)throw new Error(`Internal error fetching entries from Caisy: ${e.statusText}`);const t=await e.json();if(t.errors)throw new Error(`getEntitiesByPage from caisy - internal error fetching entries from caisy: ${JSON.stringify(t.errors)}`);return t},w=async e=>{const{projectId:t,query:s,...r}=e,n=g(t),o=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json","x-caisy-token":process.env.CMS_ACCESS_TOKEN},body:JSON.stringify({query:s,variables:{...r}})}),a=await f(o);return l(a.data[Object.keys(a.data)[0]])},_=async e=>{const{projectId:t,query:s,attribute:r,...n}=e,o=g(t);try{const a=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json","x-caisy-token":process.env.CMS_ACCESS_TOKEN},body:JSON.stringify({query:s,variables:{value:e?.[`${r}`]??"",...n}})}),y=await f(a);return p(y)}catch(a){throw new Error(a.message)}},S=async e=>{const{projectId:t,query:s,perPage:r,after:n="",page:o,...a}=e,y=g(t),i=Number.parseInt(e.page??"1"),u=Number.parseInt(e.perPage??"10"),b=n?u:(i>1?i-1:i)*u,O=await fetch(y,{method:"POST",headers:{"Content-Type":"application/json","x-caisy-token":process.env.CMS_ACCESS_TOKEN},body:JSON.stringify({query:s,variables:{first:b,after:n,...a}})}),d=await f(O);if(!d.data)return[];const{endCursor:P,hasNextPage:C}=d.data[Object.keys(d.data)[0]].pageInfo;return i===1||!C||n?l(d.data[Object.keys(d.data)[0]],i.toString()):await S({projectId:t,query:s,perPage:r,...a,page:i.toString(),after:P})},E=async e=>{const{projectId:t,query:s,...r}=e,n=g(t),o=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json","x-caisy-token":process.env.CMS_ACCESS_TOKEN},body:JSON.stringify({query:s,variables:{...r}})}),a=await f(o),y=a.data[Object.keys(a.data)[0]];return j(y)},j=e=>{const t={pageInfo:{},edges:[{node:{...e}}]};return l(t)};exports.getEntities=w;exports.getEntitiesWithPagination=S;exports.getEntityByAttribute=_;exports.getSingleEntityType=E;exports.normalizeCaisyAssetData=h;exports.normalizeCaisyItemContent=p;exports.normalizeCaisyListContent=l;exports.normalizeSingleTypeAsList=j;
