"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const y=(t,r)=>{let e=r?parseInt(r):1;(!e||isNaN(e))&&(e=1);const s=t.pageInfo?.hasNextPage??!1,n=t.pageInfo?.hasPreviousPage??!1,o=t.edges.map(a=>a.node);return{meta:{pagination:{total:o.length,hasNextPage:s,hasPrevPage:n,page:e}},data:c(o)}},l=t=>{if(!t.data||!Object.keys(t.data).length)return{meta:{pagination:{}},data:[]};const r=t.data[Object.keys(t.data)[0]];return{meta:{pagination:{}},data:[c(r)]}},c=t=>Array.isArray(t)&&!t.length?[]:t==null?t:typeof t=="object"&&!Object.keys(t).length?{}:Array.isArray(t)?t.map(r=>c(r)):typeof t=="object"&&t.json&&t.json.type==="doc"?P(t):Object.keys(t).reduce((r,e)=>Array.isArray(t[e])?(r[e]=t[e].map(s=>c(s)),r):typeof t[e]=="object"?(r[e]={...c(t[e])},r):(r[e]=t[e],r),{}),P=t=>t.connections?!t.json||typeof t.json=="string"?"":{content:t.json.content.map(e=>{if(e.type!=="documentLink"||!t.connections)return e;const s=t.connections.find(n=>n?.__typename=="Asset"&&n.id===e.attrs.documentId);return s&&(e.attrs={...e.attrs,src:s.src,title:s.title}),e}),type:t.json.type}:t.json,g=t=>`https://cloud.caisy.io/api/v3/e/${t}/graphql`,f=async t=>{if(t.status===401||t.status===403)throw new Error(`Caisy auth or permission issue: ${t.statusText}`);if(t.status!==200)throw new Error(`Internal error fetching entries from Caisy: ${t.statusText}`);const r=await t.json();if(r.errors)throw new Error(`getEntitiesByPage from caisy - internal error fetching entries from caisy: ${JSON.stringify(r.errors)}`);return r},S=async t=>{const{projectId:r,query:e}=t,s=g(r),n=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","x-caisy-token":process.env.CMS_ACCESS_TOKEN},body:JSON.stringify({query:e})}),o=await f(n);return y(o.data[Object.keys(o.data)[0]])},b=async t=>{const{projectId:r,query:e,attribute:s}=t,n=g(r);try{const o=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json","x-caisy-token":process.env.CMS_ACCESS_TOKEN},body:JSON.stringify({query:e,variables:{value:t?.[`${s}`]??""}})}),a=await f(o);return l(a)}catch(o){throw new Error(o.message)}},u=async t=>{const{projectId:r,query:e,perPage:s,after:n=""}=t,o=g(r),a=Number.parseInt(t.page??"1"),d=Number.parseInt(t.perPage??"10"),j=n?d:(a>1?a-1:a)*d,m=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json","x-caisy-token":process.env.CMS_ACCESS_TOKEN},body:JSON.stringify({query:e,variables:{first:j,after:n}})}),i=await f(m);if(!i.data)return[];const{endCursor:h,hasNextPage:p}=i.data[Object.keys(i.data)[0]].pageInfo;return a===1||!p||n?y(i.data[Object.keys(i.data)[0]],a.toString()):await u({projectId:r,query:e,perPage:s,page:a.toString(),after:h})};exports.getEntities=S;exports.getEntitiesWithPagination=u;exports.getEntityByAttribute=b;exports.normalizeCaisyItemContent=l;exports.normalizeCaisyListContent=y;
