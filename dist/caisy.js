"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const y=(e,t)=>{let r=t?parseInt(t):1;(!r||isNaN(r))&&(r=1);const s=e.pageInfo?.hasNextPage??!1,n=e.pageInfo?.hasPreviousPage??!1,a=e.edges.map(o=>o.node);return{meta:{pagination:{total:a.length,hasNextPage:s,hasPrevPage:n,page:r}},data:i(a)}},m=e=>{if(!e.data||!Object.keys(e.data).length)return{meta:{pagination:{}},data:[]};const t=e.data[Object.keys(e.data)[0]];return{meta:{pagination:{}},data:[i(t)]}},i=e=>Array.isArray(e)&&!e.length?[]:e==null?e:typeof e=="object"&&!Object.keys(e).length?{}:Array.isArray(e)?e.map(t=>i(t)):Object.keys(e._meta||{})?.length?{...i(l(e))}:typeof e=="object"&&e.json&&e.json.type==="doc"?P(e):Object.keys(e).reduce((t,r)=>Array.isArray(e[r])?(t[r]=e[r].map(s=>i(s)),t):typeof e[r]=="object"?(t[r]={...i(l(e[r]))},t):(t[r]=e[r],t),{}),l=e=>{let t=e;return t?._meta&&(t={...t,...t._meta},delete t._meta),t?.__typename==="Asset"&&(t={...t,...h(t)}),t},h=e=>({id:e.id,name:e.title,alt:e.keywords,url:e.src,assetType:e.originType,size:{height:e.height,width:e.width}}),P=e=>e.connections?!e.json||typeof e.json=="string"?"":{content:e.json.content.map(r=>{if(r.type!=="documentLink"||!e.connections)return r;const s=e.connections.find(n=>n?.__typename=="Asset"&&n.id===r.attrs.documentId);return s&&(r.attrs={...r.attrs,src:s.src,title:s.title}),r}),type:e.json.type}:e.json,g=e=>`https://cloud.caisy.io/api/v3/e/${e}/graphql`,d=async e=>{if(e.status===401||e.status===403)throw new Error(`Caisy auth or permission issue: ${e.statusText}`);if(e.status!==200)throw new Error(`Internal error fetching entries from Caisy: ${e.statusText}`);const t=await e.json();if(t.errors)throw new Error(`getEntitiesByPage from caisy - internal error fetching entries from caisy: ${JSON.stringify(t.errors)}`);return t},S=async e=>{const{projectId:t,query:r}=e,s=g(t),n=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","x-caisy-token":process.env.CMS_ACCESS_TOKEN},body:JSON.stringify({query:r})}),a=await d(n);return y(a.data[Object.keys(a.data)[0]])},w=async e=>{const{projectId:t,query:r,attribute:s}=e,n=g(t);try{const a=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json","x-caisy-token":process.env.CMS_ACCESS_TOKEN},body:JSON.stringify({query:r,variables:{value:e?.[`${s}`]??""}})}),o=await d(a);return m(o)}catch(a){throw new Error(a.message)}},u=async e=>{const{projectId:t,query:r,perPage:s,after:n=""}=e,a=g(t),o=Number.parseInt(e.page??"1"),f=Number.parseInt(e.perPage??"10"),j=n?f:(o>1?o-1:o)*f,b=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json","x-caisy-token":process.env.CMS_ACCESS_TOKEN},body:JSON.stringify({query:r,variables:{first:j,after:n}})}),c=await d(b);if(!c.data)return[];const{endCursor:C,hasNextPage:O}=c.data[Object.keys(c.data)[0]].pageInfo;return o===1||!O||n?y(c.data[Object.keys(c.data)[0]],o.toString()):await u({projectId:t,query:r,perPage:s,page:o.toString(),after:C})};exports.getEntities=S;exports.getEntitiesWithPagination=u;exports.getEntityByAttribute=w;exports.normalizeCaisyAssetData=h;exports.normalizeCaisyItemContent=m;exports.normalizeCaisyListContent=y;
